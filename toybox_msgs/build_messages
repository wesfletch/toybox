#!/usr/bin/env bash

# Automatically generate the protobuf messages defined
#   in the subdirectories of toybox_msgs
# TODO: make this work top-down, instead of calling
#   each subdirs copy of this, so that I can cross-reference msgs

SCRIPT="$(realpath "$0")"
BASEDIR="$(dirname "${SCRIPT}")"

pushd "./src/toybox_msgs" >>/dev/null|| exit

for directory in */; do # loop through all subdirs

    IN_DIR="${BASEDIR}/${directory}/proto"
    OUT_DIR="${BASEDIR}/${directory}"

    # if a directory has it's own build_messages exec, just do that
    if [[ -x "${directory}/build_messages" ]]; then
        echo "Executing sub-dir build_messages: ${directory}"
        if ! "${directory}/build_messages"; then
            echo "ERR: failed to build_messages for ${directory}."
            exit 1
        fi
    else
        [[ "${directory}" == "build" ]] && continue
        [[ ! -d "${IN_DIR}" ]] && continue

        if [[ ! -d "${OUT_DIR}" ]]; then
            mkdir -p "${OUT_DIR}"
        fi
        
        # cp initpy.txt "${OUT_DIR}/__init__.py"

        echo "Building messages in ${IN_DIR}"
        # protoc -I="${IN_DIR}" \
        #     --python_out="${OUT_DIR}" \
        #     ${IN_DIR}/*.proto
        python3 -m grpc_tools.protoc \
            -I="${IN_DIR}" \
            --python_out="${OUT_DIR}" \
            ${IN_DIR}/*.proto
    fi
done

popd >>/dev/null || exit